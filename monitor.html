<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S60/M60 混凝土強度監控中心</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse (CSV Parser) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        slate: {
                            850: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        },
                        neon: {
                            green: '#00ff9d',
                            blue: '#00ccff',
                            red: '#ff3366',
                            purple: '#bf00ff',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        .stat-value {
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>

<body class="min-h-screen p-4 md:p-8 bg-gradient-to-br from-slate-950 to-slate-900">

    <!-- Header -->
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-neon-blue to-neon-green">
                Concrete Strength Monitor
            </h1>
            <p class="text-slate-400 text-sm mt-1">S60 / M60 推進管即時監控儀表板 (v8)</p>
        </div>
        <div
            class="flex items-center gap-2 text-xs text-slate-500 bg-slate-900 px-3 py-1.5 rounded-full border border-slate-800">
            <span class="w-2 h-2 rounded-full bg-neon-green animate-pulse"></span>
            System Online
            <span id="last-updated" class="ml-2 pl-2 border-l border-slate-700">Waiting for data...</span>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <div class="flex justify-center mb-8 gap-4">
        <button id="btn-s60" onclick="switchTab('S60')"
            class="px-8 py-3 rounded-full text-lg font-bold transition-all duration-300 border border-slate-700 bg-slate-800 text-slate-400 hover:text-white">
            S60 推進管
        </button>
        <button id="btn-m60" onclick="switchTab('M60')"
            class="px-8 py-3 rounded-full text-lg font-bold transition-all duration-300 border border-slate-700 bg-slate-800 text-slate-400 hover:text-white">
            M60 推進管
        </button>
    </div>

    <!-- Main Content Area -->
    <div id="dashboard-content" class="animate-fade-in">

        <!-- Top Section: KPIs + Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">

            <!-- Left: KPIs Column -->
            <div class="lg:col-span-1 flex flex-col gap-4">
                <!-- Strength KPI -->
                <div id="kpi-strength-card" class="glass-panel p-6 border-l-4 transition-colors duration-500">
                    <h3 class="text-slate-400 text-sm font-bold uppercase tracking-wider">平均強度 (Avg Strength)</h3>
                    <div class="mt-2 flex items-baseline gap-2">
                        <span id="kpi-strength" class="text-4xl font-bold stat-value text-white">--</span>
                        <span class="text-sm text-slate-500">kgf/cm²</span>
                    </div>
                </div>

                <!-- Key Factor KPI -->
                <div id="kpi-factor-card" class="glass-panel p-6 border-l-4 transition-colors duration-500">
                    <h3 id="kpi-factor-title" class="text-slate-400 text-sm font-bold uppercase tracking-wider">關鍵因子
                    </h3>
                    <div class="mt-2 flex items-baseline gap-2">
                        <span id="kpi-factor" class="text-4xl font-bold stat-value">--</span>
                        <span id="kpi-factor-unit" class="text-sm text-slate-500"></span>
                    </div>
                </div>

                <!-- Slump KPI -->
                <div class="glass-panel p-6 border-l-4 border-slate-600">
                    <h3 class="text-slate-400 text-sm font-bold uppercase tracking-wider">平均坍度 (Avg Slump)</h3>
                    <div class="mt-2 flex items-baseline gap-2">
                        <span id="kpi-slump" class="text-4xl font-bold stat-value text-slate-200">--</span>
                        <span class="text-sm text-slate-500">cm</span>
                    </div>
                </div>
            </div>

            <!-- Right: Regression Chart -->
            <div class="lg:col-span-2 glass-panel p-6 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="chart-title" class="text-xl font-bold flex items-center gap-2">
                        <!-- Dynamic Title -->
                    </h2>
                    <div id="regression-stats"
                        class="text-xs font-mono px-2 py-1 bg-slate-800 rounded border border-slate-700 text-slate-400">
                        <!-- R2 & Slope -->
                    </div>
                </div>
                <div class="flex-1 w-full relative min-h-[300px]">
                    <canvas id="mainChart"></canvas>
                </div>
                <p id="chart-desc" class="text-xs text-slate-500 mt-2 text-center">
                    <!-- Dynamic Desc -->
                </p>
            </div>
        </div>

        <!-- Bottom Section: Detailed List -->
        <div class="glass-panel p-6">
            <h2 id="table-section-title" class="text-lg font-semibold mb-4 text-slate-300 flex items-center gap-2">
                <span class="w-1 h-5 bg-slate-500 rounded-sm"></span>
                取樣明細列表 (Sampling List)
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-slate-400 text-xs uppercase tracking-wider border-b border-slate-700">
                            <th class="p-3 font-semibold">日期/批次</th>
                            <th class="p-3 font-semibold">類型</th>
                            <th class="p-3 font-semibold" id="col-key-factor">關鍵因子</th>
                            <th class="p-3 font-semibold">坍度 (cm)</th>
                            <th class="p-3 font-semibold text-right">強度 (kgf/cm²)</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="text-sm divide-y divide-slate-800/50">
                        <!-- Rows rendered by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Data Logic -->

    <!-- Feature Correlation Analysis (New Section) -->
    <div class="glass-panel p-6 mb-8 border-l-4 border-slate-500 animate-fade-in delay-200">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-xl font-bold text-white flex items-center gap-3">
                <span class="w-1 h-6 bg-slate-500 rounded-sm"></span>
                單一因子關聯分析 (Single Feature Correlation)
            </h2>
            <div class="flex items-center gap-3">
                <label class="text-slate-400 text-sm">選擇分析因子:</label>
                <select id="feature-select" onchange="updateFeatureChart()"
                    class="bg-slate-800 border border-slate-700 text-white rounded px-3 py-1 outline-none focus:border-neon-blue transition-colors">
                    <option value="表面水骨材1">扣水率/表面水 (Water Reduction)</option>
                    <option value="水膠比">水膠比 (W/B Ratio)</option>
                    <option value="最終電流">最終電流 (Final Current)</option>
                    <option value="坍度(cm)">坍度 (Slump)</option>
                    <option value="混凝土溫度(℃)">溫度 (Temperature)</option>
                    <option value="矽灰取代率">矽灰取代率 (Silica Fume)</option>
                    <option value="耗用水">耗用水 (Water Usage)</option>
                </select>
            </div>
        </div>

        <div class="w-full relative min-h-[350px]">
            <canvas id="featureChart"></canvas>
        </div>
        <p id="feature-desc" class="text-xs text-slate-500 mt-2 text-center">
            *顯示選定因子與 28 天強度的直接關聯分佈
        </p>
    </div>

    <!-- Model Accuracy Analysis (New Section) -->
    <div class="glass-panel p-6 mb-8 border-l-4 border-amber-500 animate-fade-in delay-300">
        <h2 class="text-xl font-bold text-white mb-6 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="w-1 h-6 bg-amber-500 rounded-sm"></span>
                模型準確度驗證 (Model Accuracy: Predicted vs Actual)
            </div>
            <div class="flex gap-4 text-sm font-mono">
                <div class="bg-slate-800 px-3 py-1 rounded border border-slate-700">
                    <span class="text-slate-400">R²:</span>
                    <span id="acc-r2" class="text-white font-bold">--</span>
                </div>
                <div class="bg-slate-800 px-3 py-1 rounded border border-slate-700">
                    <span class="text-slate-400">MAE:</span>
                    <span id="acc-mae" class="text-white font-bold">--</span>
                </div>
            </div>
        </h2>

        <div class="w-full relative min-h-[400px]">
            <canvas id="accuracyChart"></canvas>
        </div>
        <div class="flex justify-center gap-6 mt-4 text-xs text-slate-500">
            <div class="flex items-center gap-2">
                <span class="w-3 h-1 bg-white"></span>
                <span>理想預測線 (Perfect Line)</span>
            </div>
            <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-amber-500"></span>
                <span>正常批次 (Normal)</span>
            </div>
            <div class="flex items-center gap-2">
                <span
                    class="w-2 h-2 rounded-md border border-red-500 text-red-500 flex items-center justify-center font-bold">!</span>
                <span>異常偏差 (>15%) (Anomalies)</span>
            </div>
        </div>
    </div>

    <!-- AI Prediction Tool Section -->
    <div id="ai-tool-container"
        class="glass-panel p-6 mb-8 border-l-4 border-neon-blue animate-fade-in relative overflow-hidden">
        <div class="absolute top-0 right-0 p-4 opacity-20 pointer-events-none">
            <i class="fas fa-robot text-8xl text-white"></i>
        </div>

        <h2 class="text-xl font-bold mb-6 text-white flex items-center gap-3">
            <span class="w-1 h-6 bg-neon-blue rounded-sm"></span>
            AI 強度預測工具 (AI Strength Predictor)
            <span class="text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-400 font-mono">Model v8</span>
        </h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative z-10">
            <!-- Input Controls -->
            <div class="space-y-6">
                <!-- S60 Inputs -->
                <div id="inputs-s60" class="space-y-5">
                    <!-- W/B Ratio -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-slate-300 font-medium">水膠比 (W/B Ratio)</label>
                            <span id="val-s60-wb" class="text-neon-blue font-mono font-bold">0.32</span>
                        </div>
                        <input type="range" id="input-s60-wb" min="0.28" max="0.36" step="0.01" value="0.32"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-neon-blue hover:bg-slate-600 transition-colors">
                        <div class="flex justify-between text-xs text-slate-500 mt-1">
                            <span>0.28 (濃)</span>
                            <span>0.36 (稀)</span>
                        </div>
                    </div>

                    <!-- Slump -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-slate-300 font-medium">坍度 (Slump)</label>
                            <span id="val-s60-slump" class="text-neon-blue font-mono font-bold">4.2 cm</span>
                        </div>
                        <input type="range" id="input-s60-slump" min="1.0" max="8.0" step="0.5" value="4.2"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-neon-blue">
                    </div>

                    <!-- Temp -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-slate-300 font-medium">混凝土溫度 (Temp)</label>
                            <span id="val-s60-temp" class="text-neon-blue font-mono font-bold">28 °C</span>
                        </div>
                        <input type="range" id="input-s60-temp" min="20" max="35" step="1" value="28"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-neon-blue">
                    </div>
                </div>

                <!-- M60 Inputs (Hidden by default) -->
                <div id="inputs-m60" class="space-y-5 hidden">
                    <!-- Silica Fume -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-slate-300 font-medium">矽灰取代率 (Silica Fume)</label>
                            <span id="val-m60-sf" class="text-neon-green font-mono font-bold">6 %</span>
                        </div>
                        <input type="range" id="input-m60-sf" min="0" max="12" step="1" value="6"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-neon-green">
                    </div>

                    <!-- Final Current -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-slate-300 font-medium">最終電流 (Final Current)</label>
                            <span id="val-m60-cur" class="text-neon-green font-mono font-bold">78 A</span>
                        </div>
                        <input type="range" id="input-m60-cur" min="60" max="100" step="1" value="78"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-neon-green">
                    </div>

                    <!-- Slump -->
                    <div>
                        <div class="flex justify-between mb-2">
                            <label class="text-slate-300 font-medium">坍度 (Slump)</label>
                            <span id="val-m60-slump" class="text-neon-green font-mono font-bold">4.5 cm</span>
                        </div>
                        <input type="range" id="input-m60-slump" min="1.0" max="8.0" step="0.5" value="4.5"
                            class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-neon-green">
                    </div>
                </div>
            </div>

            <!-- Output Display -->
            <div
                class="flex flex-col justify-center items-center bg-slate-800/50 rounded-2xl p-6 border border-slate-700 shadow-inner">
                <span class="text-slate-400 text-sm font-bold uppercase tracking-wider mb-2">AI 預測 28 天強度</span>
                <div class="relative group cursor-help">
                    <span id="ai-prediction-val"
                        class="text-6xl font-black text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] transition-all duration-300">--</span>
                    <div
                        class="absolute -bottom-8 left-1/2 transform -translate-x-1/2 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap bg-black/80 px-2 py-1 rounded text-xs text-slate-300 pointer-events-none">
                        基於 v8 線性回歸模型
                    </div>
                </div>
                <span class="text-xl text-slate-500 mt-2 font-bold">kgf/cm²</span>

                <!-- Confidence Interval mockup -->
                <div class="mt-6 flex items-center gap-2 text-xs text-slate-500 bg-slate-900/50 px-3 py-1 rounded-full">
                    <i class="fas fa-chart-line"></i>
                    <span>95% 信賴區間: <span id="ai-conf-interval" class="text-slate-300">--</span></span>
                </div>

                <div id="ai-factor-impact" class="mt-4 w-full text-center">
                    <!-- Dynamic Impact Text -->
                </div>
            </div>
        </div>
    </div>

    <script src="model_data.js"></script>
    <script>
        // Prediction Logic
        function updatePrediction() {
            if (typeof MODEL_DATA === 'undefined') return;

            const model = MODEL_DATA[currentTab];
            if (!model) return;

            let score = model.intercept;

            // Helper to get scaled value
            const getScaled = (name, val) => {
                const feat = model.features.find(f => f.name === name);
                if (!feat) return 0; // Should not happen if name matches
                return (val - feat.mean) / feat.scale * feat.coef;
            };

            // Add contribution of visible sliders
            if (currentTab === 'S60') {
                const wb = parseFloat(document.getElementById('input-s60-wb').value);
                const slump = parseFloat(document.getElementById('input-s60-slump').value);
                const temp = parseFloat(document.getElementById('input-s60-temp').value);

                score += getScaled('水膠比', wb);
                score += getScaled('坍度(cm)', slump);
                score += getScaled('混凝土溫度(℃)', temp);

                // Update Labels
                document.getElementById('val-s60-wb').innerText = wb.toFixed(2);
                document.getElementById('val-s60-slump').innerText = slump.toFixed(1) + ' cm';
                document.getElementById('val-s60-temp').innerText = temp + ' °C';

            } else {
                const sf = parseFloat(document.getElementById('input-m60-sf').value);
                const cur = parseFloat(document.getElementById('input-m60-cur').value);
                const slump = parseFloat(document.getElementById('input-m60-slump').value);

                score += getScaled('矽灰取代率', sf);
                score += getScaled('最終電流', cur);
                score += getScaled('坍度(cm)', slump);

                // Update Labels
                document.getElementById('val-m60-sf').innerText = sf + ' %';
                document.getElementById('val-m60-cur').innerText = cur + ' A';
                document.getElementById('val-m60-slump').innerText = slump.toFixed(1) + ' cm';
            }

            // Add contribution of HIDDEN features (assumed to be at MEAN, so scaled value is 0)
            // Linear Model: Intercept + Sum(Coef * (Input - Mean)/Scale)
            // If Input = Mean, term is 0. So we don't need to add anything!

            const result = Math.round(score);
            const el = document.getElementById('ai-prediction-val');

            // Animation
            // el.style.transform = 'scale(1.1)';
            // setTimeout(() => el.style.transform = 'scale(1)', 100);

            let colorClass = currentTab === 'S60' ? 'text-neon-purple' : 'text-neon-green';
            // Force white for better contrast or use neon
            // el.className = `text-6xl font-black ${colorClass} drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] transition-all duration-300`;
            el.innerText = result;

            // Interval (approx RMSE ~45)
            const margin = 45;
            document.getElementById('ai-conf-interval').innerText = `${result - margin} ~ ${result + margin}`;
        }

        // Bind Events
        ['s60-wb', 's60-slump', 's60-temp', 'm60-sf', 'm60-cur', 'm60-slump'].forEach(id => {
            const el = document.getElementById(`input-${id}`);
            if (el) el.addEventListener('input', updatePrediction);
        });

        // Update on tab switch
        const originalSwitch = switchTab;
        switchTab = function (tab) {
            originalSwitch(tab);

            // Toggle AI inputs
            if (tab === 'S60') {
                document.getElementById('inputs-s60').classList.remove('hidden');
                document.getElementById('inputs-m60').classList.add('hidden');
                document.getElementById('ai-tool-container').className = "glass-panel p-6 mb-8 border-l-4 border-neon-purple animate-fade-in relative overflow-hidden";
            } else {
                document.getElementById('inputs-s60').classList.add('hidden');
                document.getElementById('inputs-m60').classList.remove('hidden');
                document.getElementById('ai-tool-container').className = "glass-panel p-6 mb-8 border-l-4 border-neon-green animate-fade-in relative overflow-hidden";
            }
            updatePrediction();
        };

        // Init call
        setTimeout(updatePrediction, 500); // Delay to ensure model loaded
    </script>
    <script>


        const CSV_URL = 'S60_M60_dataset_v8_shared.csv';

        const CONFIG = {
            S60: {
                color: '#bf00ff', // Neon Purple
                bg: 'rgba(191, 0, 255, 0.2)',
                factorKey: '水膠比',
                factorLabel: '水膠比 (W/B Ratio)',
                factorUnit: '',
                xLabel: '水膠比 (W/B)',
                desc: '*水膠比越低 (越濃) -> 強度越高 (負相關)',
                kpiTitle: '平均水膠比',
                expectedTrend: 'down' // Lower X = Higher Y
            },
            M60: {
                color: '#00ff9d', // Neon Green
                bg: 'rgba(0, 255, 157, 0.2)',
                factorKey: '最終電流',
                factorLabel: '最終電流 (Final Current)',
                factorUnit: 'Amps',
                xLabel: '最終電流 (A)',
                desc: '*電流越高 (料越乾) -> 強度越高 (正相關)',
                kpiTitle: '平均最終電流',
                expectedTrend: 'up' // Higher X = Higher Y
            }
        };

        // Linear Regression Calculation: y = mx + b
        function calculateRegression(points) {
            const n = points.length;
            if (n === 0) return null;

            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            points.forEach(p => {
                sumX += p.x;
                sumY += p.y;
                sumXY += p.x * p.y;
                sumXX += p.x * p.x;
            });

            const denominator = (n * sumXX - sumX * sumX);
            if (denominator === 0) return { slope: 0, intercept: sumY / n }; // Handle vertical line or all x-values are same

            const slope = (n * sumXY - sumX * sumY) / denominator;
            const intercept = (sumY - slope * sumX) / n;

            // Simple R2 calculation (optional, keeping it light)

            return { slope, intercept };
        }

        function switchTab(tab) {
            currentTab = tab;
            render();
        }

        async function init() {
            const response = await fetch(CSV_URL);
            const csvText = await response.text();

            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    allData = results.data.filter(d => d.match_key); // Basic filter

                    // Initial Render
                    switchTab('S60');

                    const now = new Date();
                    document.getElementById('last-updated').innerText = `Updated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
                },
                error: function (err) {
                    console.error("CSV Load Error:", err);
                }
            });
        }

        function render() {
            const conf = CONFIG[currentTab];
            const data = allData.filter(d => d['母體'] === currentTab);

            // 1. Update Tabs Visuals
            ['S60', 'M60'].forEach(t => {
                const btn = document.getElementById(`btn-${t.toLowerCase()}`);
                if (t === currentTab) {
                    btn.className = `px-8 py-3 rounded-full text-lg font-bold transition-all duration-300 border shadow-[0_0_15px_${CONFIG[t].color}50] text-white scale-105`;
                    btn.style.backgroundColor = CONFIG[t].color;
                    btn.style.borderColor = CONFIG[t].color;
                } else {
                    btn.className = 'px-8 py-3 rounded-full text-lg font-bold transition-all duration-300 border border-slate-700 bg-slate-800 text-slate-400 hover:text-white hover:bg-slate-700';
                    btn.style.backgroundColor = '';
                    btn.style.borderColor = '';
                }
            });

            // 2. Update KPI Cards
            const avgStrength = data.reduce((a, b) => a + parseFloat(b['平均強度'] || 0), 0) / data.length;
            const avgFactor = data.reduce((a, b) => a + parseFloat(b[conf.factorKey] || 0), 0) / data.length;
            const avgSlump = data.reduce((a, b) => a + parseFloat(b['坍度(cm)'] || 0), 0) / data.length; // Note: '坍度(cm)' from CSV

            // Strength Card
            const kpiStrCard = document.getElementById('kpi-strength-card');
            kpiStrCard.style.borderColor = conf.color;
            document.getElementById('kpi-strength').innerText = avgStrength.toFixed(0);

            // Factor Card
            const kpiFactorCard = document.getElementById('kpi-factor-card');
            kpiFactorCard.style.borderColor = conf.color;
            document.getElementById('kpi-factor-title').innerText = conf.kpiTitle;
            document.getElementById('kpi-factor').innerText = avgFactor.toFixed(2);
            document.getElementById('kpi-factor').style.color = conf.color;
            document.getElementById('kpi-factor-unit').innerText = conf.factorUnit;

            // Slump Card
            document.getElementById('kpi-slump').innerText = avgSlump.toFixed(1);

            // 3. Update Chart (Scatter + Regression)
            updateChart(data, conf);

            // 4. Update Table
            updateTable(data, conf);
        }

        function updateChart(data, conf) {
            const ctx = document.getElementById('mainChart');

            // Prepare Data Points
            const points = data.map(d => ({
                x: parseFloat(d[conf.factorKey]),
                y: parseFloat(d['平均強度']),
                raw: d
            })).filter(p => !isNaN(p.x) && !isNaN(p.y) && p.x > 0);

            // Calculate Regression Line
            const reg = calculateRegression(points);

            // Generate Line Points (Min X to Max X)
            let minX = Math.min(...points.map(p => p.x));
            let maxX = Math.max(...points.map(p => p.x));

            // Add some padding to min/max X for better visualization
            const xRange = maxX - minX;
            minX = minX - xRange * 0.1;
            maxX = maxX + xRange * 0.1;

            const linePoints = reg ? [
                { x: minX, y: reg.slope * minX + reg.intercept },
                { x: maxX, y: reg.slope * maxX + reg.intercept }
            ] : [];

            // Regression Stats Display
            const rStat = document.getElementById('regression-stats');
            if (reg) {
                const slopeDir = reg.slope > 0 ? "正相關 (Positive)" : "負相關 (Negative)";
                rStat.innerText = `Trend: ${slopeDir} | Slope: ${reg.slope.toFixed(1)}`;
                rStat.style.borderColor = conf.color;
                rStat.style.color = conf.color;
            } else {
                rStat.innerText = 'No data for regression';
                rStat.style.borderColor = 'transparent';
                rStat.style.color = '#slate-400';
            }


            // Update Chart Title & Desc
            const titleEl = document.getElementById('chart-title');
            titleEl.innerHTML = `<span class="w-2 h-6 rounded-sm" style="background-color: ${conf.color}"></span> ${conf.factorLabel} vs 強度`;
            titleEl.style.color = conf.color;

            document.getElementById('chart-desc').innerText = conf.desc;

            // Destroy old chart
            if (mainChart) mainChart.destroy();

            mainChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Batch Data',
                            data: points,
                            backgroundColor: conf.color,
                            borderColor: conf.color,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointStyle: 'rectRot'
                        },
                        {
                            type: 'line',
                            label: 'Regression Trend',
                            data: linePoints,
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#94a3b8' } },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    if (ctx.dataset.type === 'line') return '';
                                    const p = ctx.raw;
                                    return `${p.raw.match_key}: ${p.y} kgf/cm² (${conf.factorKey}: ${p.x})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: conf.xLabel, color: '#64748b' },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            title: { display: true, text: '強度 (Strength)', color: '#64748b' },
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' },
                            min: 0 // Optional
                        }
                    }
                }
            });
        }

        function updateTable(data, conf) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            // Update Header Name and Section Title
            document.getElementById('col-key-factor').innerText = `關鍵因子 (${conf.factorKey})`;
            document.getElementById('table-section-title').innerHTML = `
                <span class="w-1 h-5 bg-slate-500 rounded-sm"></span>
                ${currentTab} 推進管 取樣明細列表 (Sampling List)
            `;

            // Sort by Date Desc (Latest first)
            const sorted = [...data].sort((a, b) => b.match_key.localeCompare(a.match_key)).slice(0, 10);

            sorted.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800/50 transition-colors border-b border-slate-800/50 last:border-0";

                const val = parseFloat(row[conf.factorKey] || 0).toFixed(2);

                tr.innerHTML = `
                    <td class="p-3 font-mono text-slate-300">${row['日期']} <span class="text-slate-500 text-xs text-xs ml-1">${row.match_key}</span></td>
                    <td class="p-3"><span class="px-2 py-0.5 rounded textxs font-bold ${currentTab === 'M60' ? 'bg-neon-green/10 text-neon-green' : 'bg-neon-purple/10 text-neon-purple'}">${row['母體']}</span></td>
                    <td class="p-3 font-mono text-white">${val} ${conf.factorUnit}</td>
                    <td class="p-3 text-slate-400">${row['坍度(cm)'] || '--'}</td>
                    <td class="p-3 text-right font-bold text-white">${row['平均強度']}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Feature Chart Logic
        let featureChart = null;

        function updateFeatureChart() {
            const featureName = document.getElementById('feature-select').value;
            const featureLabel = document.getElementById('feature-select').options[document.getElementById('feature-select').selectedIndex].text;

            // Filter Data
            const dataset = allData.filter(d => d.母體 === currentTab && d.平均強度 > 100);

            // Prepare Points
            const points = dataset.map(d => ({
                x: parseFloat(d[featureName]) || 0,
                y: parseFloat(d.平均強度) || 0
            })).filter(p => p.x > 0);

            const ctx = document.getElementById('featureChart').getContext('2d');

            if (featureChart) {
                featureChart.destroy();
            }

            // Simple Linear Regression for Trend Line
            const regression = calculateRegression(points);
            const regLine = points.map(p => ({
                x: p.x,
                y: regression.slope * p.x + regression.intercept
            })).sort((a, b) => a.x - b.x);


            const color = currentTab === 'S60' ? 'rgba(139, 92, 246, 0.6)' : 'rgba(34, 197, 94, 0.6)';
            const pointColor = currentTab === 'S60' ? '#c4b5fd' : '#86efac';

            featureChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: `${featureLabel} vs 強度`,
                            data: points,
                            backgroundColor: pointColor,
                            borderColor: color,
                            borderWidth: 1,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: '趨勢線 (Trend)',
                            data: [regLine[0], regLine[regLine.length - 1]], // Start and End point
                            type: 'line',
                            borderColor: '#ffffff',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: {
                                display: true,
                                text: featureLabel,
                                color: '#94a3b8'
                            },
                            grid: { color: '#334155' },
                            ticks: { color: '#cbd5e1' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '強度 (kgf/cm²)',
                                color: '#94a3b8'
                            },
                            grid: { color: '#334155' },
                            ticks: { color: '#cbd5e1' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#cbd5e1' } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `(${context.parsed.x}, ${context.parsed.y} kgf/cm²)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Accuracy Chart Logic
        let accuracyChart = null;

        function updateAccuracyChart() {
            if (typeof MODEL_DATA === 'undefined') return;
            const model = MODEL_DATA[currentTab];
            if (!model) return;

            // Filter Valid Data
            const dataset = allData.filter(d => d.母體 === currentTab && d.平均強度 > 100);

            let sumSqureRes = 0;
            let sumSquareTot = 0;
            let sumAbsErr = 0;
            let yMean = dataset.reduce((a, b) => a + (parseFloat(b.平均強度) || 0), 0) / dataset.length;

            const predPoints = [];
            const outliers = [];

            dataset.forEach(d => {
                const actual = parseFloat(d.平均強度);

                // Calculate Prediction
                let pred = model.intercept;
                model.features.forEach(feat => {
                    const val = parseFloat(d[feat.name]) || 0;
                    if (feat.scale !== 0) {
                        pred += (val - feat.mean) / feat.scale * feat.coef;
                    }
                });

                // Metrics
                sumSqureRes += Math.pow(actual - pred, 2);
                sumSquareTot += Math.pow(actual - yMean, 2);
                sumAbsErr += Math.abs(actual - pred);

                // Check Anomaly (> 15% Error)
                const errorPct = Math.abs(actual - pred) / actual;
                const point = { x: pred, y: actual, match_key: d.match_key };

                if (errorPct > 0.15) {
                    outliers.push(point);
                } else {
                    predPoints.push(point);
                }
            });

            // Calc Stats
            const r2 = 1 - (sumSqureRes / sumSquareTot);
            const mae = sumAbsErr / dataset.length;

            // Update DOM
            document.getElementById('acc-r2').innerText = r2.toFixed(3);
            document.getElementById('acc-mae').innerText = mae.toFixed(1);

            // Chart
            const ctx = document.getElementById('accuracyChart').getContext('2d');
            if (accuracyChart) accuracyChart.destroy();

            // Perfect Line (Min to Max)
            const minVal = Math.min(...predPoints.map(p => p.x), ...predPoints.map(p => p.y)) - 50;
            const maxVal = Math.max(...predPoints.map(p => p.x), ...predPoints.map(p => p.y)) + 50;

            accuracyChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '正常預測 (Normal)',
                            data: predPoints,
                            backgroundColor: '#fbbf24', // Amber-400
                            pointRadius: 4,
                            pointHoverRadius: 6
                        },
                        {
                            label: '異常偏差 (Anomaly)',
                            data: outliers,
                            backgroundColor: '#ef4444', // Red-500
                            pointRadius: 5,
                            pointStyle: 'triangle',
                            pointHoverRadius: 7
                        },
                        {
                            label: '完美預測線 (Ideal)',
                            data: [{ x: minVal, y: minVal }, { x: maxVal, y: maxVal }],
                            type: 'line',
                            borderColor: '#ffffff',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            title: { display: true, text: 'AI 預測強度 (Predicted)', color: '#94a3b8' },
                            grid: { color: '#334155' },
                            ticks: { color: '#cbd5e1' }
                        },
                        y: {
                            title: { display: true, text: '實際強度 (Actual)', color: '#94a3b8' },
                            grid: { color: '#334155' },
                            ticks: { color: '#cbd5e1' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#cbd5e1' } },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const p = context.raw;
                                    return `${p.match_key || ''}: Pred ${p.x.toFixed(0)} vs Act ${p.y} kgf/cm²`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize Everything
        function initApp() {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                dynamicTyping: true,
                complete: function (results) {
                    allData = results.data;
                    initDashboard(); // Load Main Dashboard
                    updatePrediction(); // Init AI Tool
                    updateFeatureChart(); // Init Feature Chart
                    updateAccuracyChart(); // Init Accuracy Chart
                }
            });

            // Hook into tab switch to update accuracy charts too
            const oldSwitch = switchTab;
            switchTab = function (tab) {
                // Call previous wrapped switch (which includes AI tool update)
                // Note: The previous wrap logic in monitor.html was:
                // constant originalSwitch = switchTab;
                // switchTab = function(tab) { originalSwitch(tab); ... updatePrediction(); }
                // So calling oldSwitch here invokes the whole chain.

                // We need to re-find the function because it was overwritten in global scope
                // But better pattern: Just override 'switchTab' ONCE cleanly or rely on event listeners.
                // Given the messy override history, let's just re-implement the chain here safely.

                currentTab = tab;

                // Update UI Buttons
                document.getElementById('btn-s60').className = tab === 'S60'
                    ? "px-8 py-3 rounded-full text-lg font-bold transition-all duration-300 bg-neon-purple text-white shadow-[0_0_20px_rgba(168,85,247,0.5)] transform scale-105"
                    : "px-8 py-3 rounded-full text-lg font-bold transition-all duration-300 border border-slate-700 bg-slate-800 text-slate-400 hover:text-white";

                document.getElementById('btn-m60').className = tab === 'M60'
                    ? "px-8 py-3 rounded-full text-lg font-bold transition-all duration-300 bg-neon-green text-black shadow-[0_0_20px_rgba(34,197,94,0.5)] transform scale-105"
                    : "px-8 py-3 rounded-full text-lg font-bold transition-all duration-300 border border-slate-700 bg-slate-800 text-slate-400 hover:text-white";

                updateKpiDisplay();
                updateMainChart();
                updateTable(allData.filter(d => d.母體 === tab), { factorKey: tab === 'S60' ? '水灰比' : '最終電流', factorUnit: tab === 'S60' ? '' : 'A' });

                // AI Tool Toggle
                if (tab === 'S60') {
                    document.getElementById('inputs-s60').classList.remove('hidden');
                    document.getElementById('inputs-m60').classList.add('hidden');
                    document.getElementById('ai-tool-container').className = "glass-panel p-6 mb-8 border-l-4 border-neon-purple animate-fade-in relative overflow-hidden";
                } else {
                    document.getElementById('inputs-s60').classList.add('hidden');
                    document.getElementById('inputs-m60').classList.remove('hidden');
                    document.getElementById('ai-tool-container').className = "glass-panel p-6 mb-8 border-l-4 border-neon-green animate-fade-in relative overflow-hidden";
                }

                updatePrediction();
                updateFeatureChart();
                updateAccuracyChart();
            };
        }

        window.onload = initApp;
    </script>
</body>

</html>